#!/bin/bash

IDENTITY_FILE="~/.ssh/${USER}-lumosity-key"
GITHUB_IDENTITIY_FILE='~/.ssh/github_dsa'

nodes=$(mktemp)
ssh_config=$(mktemp)

add_node_ssh() {
  private_dns=$1
  hostname=$2
  cat >> $ssh_config <<EOF
Host ${hostname} ${hostname}.aws.lumoslabs.com
ProxyCommand ssh -q jump-aws nc ${private_dns} 22
User lumoslabs
IdentityFile ${IDENTITY_FILE}

EOF
}

# Format knife search results as:
# [ec2.hostname] [hostname]
# ip-1-2-3-4.ec2.internal app01
pushd ~ >/dev/null
bundle exec knife search '*' -a ec2.hostname -a hostname 2>/dev/null | \
  awk '{ getline b; getline c; getline d; printf("%s %s\n",b,c) }' | \
  awk '{print $2 " " $4}' > $nodes
popd >/dev/null

cat > $ssh_config <<EOF
################################################################################
# WARNING: Do not edit this file! It is generated by update_ssh_configs.
#
# Customizations may be added in ~/.ssh/config_extra. These are appended to
# ~/.ssh/config by update_ssh_configs.
################################################################################

# Prevent ssh timeouts when connections go idle
ServerAliveInterval 120
ServerAliveCountMax 3
TCPKeepAlive yes

# Add github key
Host github.com
User git
IdentityFile $GITHUB_IDENTITY_FILE

#----------------------------------------------
# OFFICE SERVERS

Host brainiac
User lumos

#----------------------------------------------
# AWS SERVERS

Host jump-aws
HostName jump-aws.lumoslabs.com
User lumoslabs
IdentityFile ${IDENTITY_FILE}
ControlPath ~/.ssh/controlmasters/%r@%h:%p
ControlMaster auto
ControlPersist 10m

Host *.ec2.internal
ProxyCommand ssh -q jump-aws nc %h 22
User lumoslabs
IdentityFile ${IDENTITY_FILE}

EOF

cat $nodes | while read node; do
  add_node_ssh $node
done

touch ~/.ssh/config_extra
cat >> $ssh_config < ~/.ssh/config_extra

# echo "[DEBUG] New ssh_config stored in: ${ssh_config}"

# TODO: Remove this safeguard once we're happy with the generated config file
cp ~/.ssh/config ~/.ssh/config.old-$(date "+%Y%m%d%H%M%S")

mv $ssh_config ~/.ssh/config
